!function(t,s){if("object"==typeof exports&&"object"==typeof module)module.exports=s();else if("function"==typeof define&&define.amd)define([],s);else{var i=s();for(var e in i)("object"==typeof exports?exports:t)[e]=i[e]}}(self,(()=>(()=>{"use strict";var t={};return(()=>{var s=t;Object.defineProperty(s,"__esModule",{value:!0});var i=class{constructor(){this.listeners=new Set,this.register=this._register.bind(this)}_register(t){return this.listeners.add(t),{dispose:()=>{this.listeners.delete(t)}}}fire(t){for(const s of this.listeners)try{s(t)}catch(t){console.error(t)}}},e=10,o=t=>48<=t&&t<=57||65<=t&&t<=90||95==t||97<=t&&t<=122,r=t=>0<=t&&t<=31&&9!=t||127==t,h=t=>128==(192&t),a=t=>65<=t&&t<=90?t+32:t,l=t=>97<=t&&t<=122?t-32:t,n=new TextEncoder,c=t=>Array.from(n.encode(t)),T=(t=>(t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8",t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY",t[t.XTABS=6144]="XTABS",t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN",t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2",t))(T||{}),f=class t{constructor(t,s,i,e,o){this.iflag=t,this.oflag=s,this.cflag=i,this.lflag=e,this.cc=o,this.ISTRIP_P=0!=(32&this.iflag),this.INLCR_P=0!=(64&this.iflag),this.IGNCR_P=0!=(128&this.iflag),this.ICRNL_P=0!=(256&this.iflag),this.IUCLC_P=0!=(512&this.iflag),this.IXON_P=0!=(1024&this.iflag),this.IXANY_P=0!=(2048&this.iflag),this.IUTF8_P=0!=(16384&this.iflag),this.OPOST_P=0!=(1&this.oflag),this.OLCUC_P=0!=(2&this.oflag),this.ONLCR_P=0!=(4&this.oflag),this.OCRNL_P=0!=(8&this.oflag),this.ONOCR_P=0!=(16&this.oflag),this.ONLRET_P=0!=(32&this.oflag),this.TABDLY_XTABS_P=6144==(6144&this.oflag),this.ISIG_P=0!=(1&this.lflag),this.ICANON_P=0!=(2&this.lflag),this.ECHO_P=0!=(8&this.lflag),this.ECHOE_P=0!=(16&this.lflag),this.ECHOK_P=0!=(32&this.lflag),this.ECHONL_P=0!=(64&this.lflag),this.NOFLSH_P=0!=(128&this.lflag),this.ECHOCTL_P=0!=(512&this.lflag),this.ECHOPRT_P=0!=(1024&this.lflag),this.ECHOKE_P=0!=(2048&this.lflag),this.IEXTEN_P=0!=(32768&this.lflag),this.INTR_V=this.cc[0],this.QUIT_V=this.cc[1],this.ERASE_V=this.cc[2],this.KILL_V=this.cc[3],this.EOF_V=this.cc[4],this.TIME_V=this.cc[5],this.MIN_V=this.cc[6],this.SWTCH_V=this.cc[7],this.START_V=this.cc[8],this.STOP_V=this.cc[9],this.SUSP_V=this.cc[10],this.EOL_V=this.cc[11],this.REPRINT_V=this.cc[12],this.DISCARD_V=this.cc[13],this.WERASE_V=this.cc[14],this.LNEXT_V=this.cc[15],this.EOL2_V=this.cc[16]}static fromConfig(s){return new t(s.iflag,s.oflag,s.cflag,s.lflag,s.cc)}clone(){return t.fromConfig(this)}},u=new f(25856,5,191,35387,[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),p=class{constructor(){this._onWriteToLower=new i,this.onWriteToLower=this._onWriteToLower.register,this._onWriteToUpper=new i,this.onWriteToUpper=this._onWriteToUpper.register,this._onSignalToUpper=new i,this.onSignalToUpper=this._onSignalToUpper.register,this._onFlowActivated=new i,this.onFlowActivated=this._onFlowActivated.register,this._onFlowDeactivated=new i,this.onFlowDeactivated=this._onFlowDeactivated.register,this.T=u,this.keyActions=new Array(256).fill("normal"),this.flowActivated=!0,this.column=0,this.baseColumn=0,this.vlnext=!1,this.echoprt=!1,this.toLowerBuf=[],this.toUpperBuf=[],this.termios=u}activateFlow(){this.flowActivated=!0,this._onFlowActivated.fire()}deactivateFlow(){this.flowActivated=!1,this._onFlowDeactivated.fire()}get flow(){return this.flowActivated}get termios(){return this.T}set termios(t){this.T=t;const s=new Array(256).fill("normal");t.ICANON_P&&(s[t.EOF_V]="VEOF",s[t.EOL_V]="VEOL",s[t.EOL2_V]="VEOL",s[t.ERASE_V]="VERASE",s[t.KILL_V]="VKILL",t.IEXTEN_P&&(s[t.REPRINT_V]="VREPRINT",s[t.WERASE_V]="VWERASE")),t.IEXTEN_P&&(s[t.LNEXT_V]="VLNEXT"),t.IXON_P&&(s[t.START_V]="VSTART",s[t.STOP_V]="VSTOP"),t.ISIG_P&&(s[t.INTR_V]="VINTR",s[t.QUIT_V]="VQUIT",s[t.SUSP_V]="VSUSP"),s[0]="normal",this.keyActions=s,this.T.IXON_P||(this.activateFlow(),this.flushToLower())}clearToLower(){this.toLowerBuf.length=0}flushToLower(){0!=this.flowActivated&&(this._onWriteToLower.fire(this.toLowerBuf),this.clearToLower())}outputToLower(t){this.toLowerBuf.push(...t)}updateBaseColumn(){0==this.toUpperBuf.length&&(this.baseColumn=this.column)}clearToUpper(){this.toUpperBuf.length=0,this.updateBaseColumn()}flushToUpper(){this._onWriteToUpper.fire(this.toUpperBuf),this.clearToUpper()}outputToUpper(t){this.toUpperBuf.push(t)}outputToLowerWithPostprocess(t){if(this.T.OPOST_P)switch(t){case 8:this.column>0&&this.column--,this.outputToLower([8]);break;case 9:{const t=8-this.column%8;this.column+=t,this.outputToLower(this.T.TABDLY_XTABS_P?new Array(t).fill(32):[9]);break}case e:this.T.ONLCR_P?(this.baseColumn=this.column=0,this.outputToLower([13,e])):this.T.ONLRET_P?(this.column=0,this.outputToLower([e])):(this.baseColumn=this.column,this.outputToLower([e]));break;case 13:this.T.ONOCR_P&&0==this.column||(this.T.OCRNL_P?(this.T.ONLRET_P&&(this.baseColumn=this.column=0),this.outputToLower([e])):(this.baseColumn=this.column=0,this.outputToLower([13])));break;default:this.T.IUTF8_P&&h(t)||this.column++,this.outputToLower(this.T.OLCUC_P?[l(t)]:[t])}else this.outputToLower([t])}echoToLower(t,s){"number"==typeof t&&(t=[t]);for(const i of t)this.T.ECHOCTL_P&&r(i)&&9!=i&&!s?(this.outputToLower([94,64^i]),this.column+=2):this.outputToLowerWithPostprocess(i)}inputFromLowerWithPreprocess(t){if(13==t){if(this.T.IGNCR_P)return;this.T.ICRNL_P&&(t=e)}else t==e&&this.T.INLCR_P&&(t=13);this.T.ICANON_P&&t==e?((this.T.ECHO_P||this.T.ECHONL_P)&&(this.echoToLower(e,!0),this.flushToLower()),this.outputToUpper(e),this.flushToUpper()):this.T.ECHO_P?(this.finishECHOPRT(),this.updateBaseColumn(),t==e?this.echoToLower(e,!0):this.echoToLower(t),this.flushToLower(),this.outputToUpper(t)):this.outputToUpper(t)}erase(t){if(0==this.toUpperBuf.length)return;if("VKILL"==t){if(!this.T.ECHO_P)return void this.clearToUpper();if(!this.T.ECHOK_P||!this.T.ECHOKE_P||!this.T.ECHOE_P)return this.clearToUpper(),this.finishECHOPRT(),this.echoToLower(this.T.KILL_V),void(this.T.ECHOK_P&&this.echoToLower(e,!0))}let s=!1;for(let i=this.toUpperBuf.length-1;i>=0;i--){const e=this.toUpperBuf[i];if(this.T.IUTF8_P&&h(e))continue;if("VWERASE"==t)if(o(e)||95==e)s=!0;else if(s)break;const a=this.toUpperBuf.splice(i);if(this.T.ECHO_P)if(this.T.ECHOPRT_P)this.startECHOPRT(),this.echoToLower(a);else if("VERASE"!=t||this.T.ECHOE_P)if(9==e){let t=0,s=!1;for(let i=this.toUpperBuf.length-1;i>=0;i--){const e=this.toUpperBuf[i];if(9==e){s=!0;break}r(e)?this.T.ECHOCTL_P&&(t+=2):this.T.IUTF8_P&&h(e)||t++}s||(t+=this.baseColumn),t=8-t%8,this.outputToLower(new Array(t).fill(8)),this.column=Math.max(0,this.column-t)}else r(e)&&this.T.ECHOCTL_P&&this.echoToLower([8,32,8],!0),r(e)&&!this.T.ECHOCTL_P||this.echoToLower([8,32,8],!0);else this.echoToLower(this.T.ERASE_V);if("VERASE"==t)break}0==this.toUpperBuf.length&&(this.clearToUpper(),this.T.ECHO_P&&this.finishECHOPRT())}startECHOPRT(){this.echoprt||(this.echoToLower(92,!0),this.echoprt=!0)}finishECHOPRT(){this.echoprt&&(this.echoToLower(47,!0),this.echoprt=!1)}signal(t,s){this._onSignalToUpper.fire(t),this.T.NOFLSH_P||(this.clearToLower(),this.clearToUpper()),this.T.IXON_P&&this.activateFlow(),this.T.ECHO_P&&this.echoToLower(s),this.flushToLower()}checkStartFlow(){0==this.flowActivated&&this.T.IXON_P&&this.T.IXANY_P&&(this.activateFlow(),this.flushToLower())}nextLiteral(){this.vlnext=!0,this.T.ECHO_P&&(this.finishECHOPRT(),this.T.ECHOCTL_P&&(this.echoToLower([94,8],!0),this.flushToLower()))}reprint(){this.finishECHOPRT(),this.echoToLower(this.T.REPRINT_V),this.echoToLower(e,!0),this.echoToLower(this.toUpperBuf)}writeFromLower(t){const s="string"==typeof t?c(t):t;for(let t of s){this.T.ISTRIP_P&&(t&=127),this.T.IUCLC_P&&this.T.IEXTEN_P&&(t=a(t));const s=this.vlnext?"normal":this.keyActions[t];switch(this.vlnext=!1,s){case"normal":this.checkStartFlow(),this.inputFromLowerWithPreprocess(t);break;case"VERASE":case"VWERASE":case"VKILL":this.checkStartFlow(),this.erase(s),this.flushToLower();break;case"VEOF":this.checkStartFlow(),this.flushToUpper();break;case"VEOL":this.checkStartFlow(),this.T.ECHO_P&&(this.echoToLower(t),this.flushToLower()),this.outputToUpper(t),this.flushToUpper();break;case"VLNEXT":this.checkStartFlow(),this.nextLiteral();break;case"VREPRINT":this.checkStartFlow(),this.reprint(),this.flushToLower();break;case"VSTART":this.activateFlow(),this.flushToLower();break;case"VSTOP":this.deactivateFlow();break;case"VINTR":this.signal("SIGINT",t);break;case"VQUIT":this.signal("SIGQUIT",t);break;case"VSUSP":this.signal("SIGTSTP",t)}}this.T.ICANON_P||this.flushToUpper()}writeFromUpper(t){if(0==this.flowActivated)throw"Do not write anything during flowStatus is stopped";const s="string"==typeof t?c(t):t;for(const t of s)this.outputToLowerWithPostprocess(t);this.flushToLower()}},L=class{constructor(t,s){this.ldisc=t,this.slave=s,this.disposables=[],this._onWrite=new i,this.onWrite=this._onWrite.register,this.fromLdiscToLowerBuffer=[],this.waitingForLower=!1;const e=()=>{if(this.fromLdiscToLowerBuffer.length>=1){this.waitingForLower=!0;const t=new Uint8Array(this.fromLdiscToLowerBuffer.splice(0,4096));this.fromLdiscToLowerBuffer.length<=4096&&this.notifyWritable(),this._onWrite.fire([t,e])}else this.waitingForLower=!1};this.ldisc.onWriteToLower((t=>{this.fromLdiscToLowerBuffer.push(...t),this.waitingForLower||e()}));const{notifyWritable:o,notifyResize:r}=s.initFromMaster();this.notifyWritable=o,this.notifyResize=r}activate(t){this.onWrite((([s,i])=>t.write(s,i)));const s=t=>this.ldisc.writeFromLower(t);this.disposables.push(t.onData(s),t.onBinary(s),t.onResize((({cols:t,rows:s})=>this.notifyResize(s,t))))}dispose(){this.disposables.forEach((t=>t.dispose())),this.disposables.length=0}},w=class{constructor(t){this.ldisc=t,this._onReadable=new i,this.onReadable=this._onReadable.register,this._onWritable=new i,this.onWritable=this._onWritable.register,this._onSignal=new i,this.onSignal=this._onSignal.register,this.fromLdiscToUpperBuffer=[],this.fromUpperToLdiscBuffer=[],this.winsize=[80,24],this.ldisc.onWriteToUpper((t=>{this.fromLdiscToUpperBuffer.push(...t),this._onReadable.fire()})),this.ldisc.onFlowActivated((()=>{this.fromUpperToLdiscBuffer.length>=1&&(this.ldisc.writeFromUpper(this.fromUpperToLdiscBuffer),this.fromUpperToLdiscBuffer.length=0)})),this.ldisc.onSignalToUpper((t=>{this._onSignal.fire(t)}))}initFromMaster(){return{notifyWritable:()=>this._onWritable.fire(),notifyResize:(t,s)=>{this.winsize=[s,t],this._onSignal.fire("SIGWINCH")}}}get readable(){return this.fromLdiscToUpperBuffer.length>=1}read(t){const s=void 0!==t?Math.min(this.fromLdiscToUpperBuffer.length,t):this.fromLdiscToUpperBuffer.length;return this.fromLdiscToUpperBuffer.splice(0,s)}get writable(){return this.fromUpperToLdiscBuffer.length<=4096}write(t){const s="string"==typeof t?c(t):t;this.fromUpperToLdiscBuffer=this.fromUpperToLdiscBuffer.concat(s),this.ldisc.flow&&(this.ldisc.writeFromUpper(this.fromUpperToLdiscBuffer),this.fromUpperToLdiscBuffer.length=0)}ioctl(t,s){switch(t){case"TCGETS":return this.ldisc.termios.clone();case"TCSETS":return void(this.ldisc.termios=f.fromConfig(s));case"TIOCGWINSZ":return this.winsize.slice()}}},E=t=>{const s=[t.iflag,t.oflag,t.cflag,t.lflag];let i=0,e=8;for(let o=0;o<t.cc.length;o++)i|=t.cc[o]<<e,e+=8,32==e&&(s.push(i),i=0,e=0);return s.push(i),s},_=t=>{const s=[];let i=4,e=t[i++],o=8;for(let r=0;r<32;r++)s.push(e>>o&255),o+=8,o>=32&&(e=t[i++],o=0);return new f(t[0],t[1],t[2],t[3],s)};s.Flags=T,s.Termios=f,s.TtyClient=class{constructor(t){this.streamCtrl=new Int32Array(t,0,1),this.streamData=new Int32Array(t,4)}req(t){this.streamCtrl[0]=0,self.postMessage(t),Atomics.wait(this.streamCtrl,0,0)}onRead(t){t||(t=this.streamData.length-1),this.req({ttyRequestType:"read",length:t});const s=this.streamData[0];return Array.from(this.streamData.slice(1,s+1))}onWrite(t){this.req({ttyRequestType:"write",buf:t})}onWaitForReadable(t){return this.req({ttyRequestType:"poll",timeout:t}),1==this.streamData[0]}onIoctlTcgets(){return this.req({ttyRequestType:"tcgets"}),_(Array.from(this.streamData.slice(0,13)))}onIoctlTcsets(t){const s=E(t);this.req({ttyRequestType:"tcsets",data:s})}onIoctlTiocgwinsz(){return this.req({ttyRequestType:"tiocgwinsz"}),[this.streamData[0],this.streamData[1]]}},s.TtyServer=class{constructor(t){this.slave=t,this.shared=new SharedArrayBuffer(260),this.streamCtrl=new Int32Array(this.shared,0,1),this.streamData=new Int32Array(this.shared,4),this.state="idle",this.timeoutHandler=null,this.fromWorkerBuf=[],this.toWorkerBuf=[],this.stop_=null,t.onWritable((()=>{this.fromWorkerBuf.length>=1&&this.feedFromWorker()})),t.onReadable((()=>{switch(this.toWorkerBuf.push(...t.read()),this.state){case"poll":this.waitForReadable(0);break;case"input":this.feedToWorker(this.toWorkerBuf.length)}})),t.onSignal((t=>{console.info(`A signal ${t} is currently ignored`)}))}ack(){Atomics.store(this.streamCtrl,0,1),Atomics.notify(this.streamCtrl,0),this.state="idle"}feedToWorker(t){if("input"!=this.state)throw"worker does not wait for input";t>this.streamData.length-1&&(t=this.streamData.length-1);const s=this.toWorkerBuf.splice(0,t);this.streamData[0]=s.length,this.streamData.set(s,1),this.ack()}feedFromWorker(){if(0==this.fromWorkerBuf.length)throw"worker does not wait for output";this.slave.writable&&(this.ack(),this.slave.write(this.fromWorkerBuf.splice(0)))}waitForReadable(t){if("poll"!=this.state)throw"worker does not wait for poll";this.timeoutHandler&&(clearTimeout(this.timeoutHandler),this.timeoutHandler=null),this.toWorkerBuf.length>0?(this.streamData[0]=1,this.ack()):t<0||(t>0?this.timeoutHandler=setTimeout((()=>this.waitForReadable(0)),1e3*t):(this.streamData[0]=2,this.ack()))}start(t,s){this.stop();let i=!1;this.stop_=()=>i=!0,t.onmessage=t=>{const e=t.data;if("object"==typeof e&&e.ttyRequestType){if(i)return;const t=e;switch(t.ttyRequestType){case"read":this.state="input",this.toWorkerBuf.length>=1&&this.feedToWorker(t.length);break;case"write":this.fromWorkerBuf.push(...t.buf),this.feedFromWorker();break;case"poll":this.state="poll",this.waitForReadable(t.timeout);break;case"tcgets":this.streamData.set(E(this.slave.ioctl("TCGETS"))),this.ack();break;case"tcsets":this.slave.ioctl("TCSETS",_(t.data)),this.ack();break;case"tiocgwinsz":{const[t,s]=this.slave.ioctl("TIOCGWINSZ");this.streamData[0]=t,this.streamData[1]=s,this.ack();break}}}else s&&s(t)},t.postMessage(this.shared)}stop(){this.stop_&&this.stop_()}},s.openpty=()=>{const t=new p,s=new w(t);return{master:new L(t,s),slave:s}}})(),t})()));
//# sourceMappingURL=index.js.map